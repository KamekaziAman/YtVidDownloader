{% extends "global_base.html" %}

{% block title %}Home{% endblock %}
{% block header %}YtVidDownloader{% endblock %}
{% block content %}
<section class="relative pt-20 pb-10">
  <div class=""></div>
  <div class="max-w-3xl mx-auto px-4">
    <div class="text-center mb-10">
      <h1 class="text-4xl font-bold tracking-tight text-gray-100">Download Youtube videos effortlessly</h1>
      <p class="mt-3 text-gray-300">Paste a URL below and choose the quality 4k ... audio only.</p>
    </div>

    {% if messages %}
      <div class="space-y-2 mb-6">
        {% for message in messages %}
          <div class="px-4 py-3 rounded-md border {{ message.tags|default:'' }} {% if 'success' in message.tags %}border-green-200 bg-green-50 text-green-800{% elif 'error' in message.tags %}border-red-200 bg-red-50 text-red-800{% else %}border-gray-200 bg-gray-50 text-gray-800{% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <form id="download-form" method="post" class="bg-slate-900/40 backdrop-blur border border-slate-800 shadow rounded-xl p-6" target="download-frame">
      {% csrf_token %}
      <div class="grid gap-4 md:grid-cols-4">
        <div class="md:col-span-3">
          <label for="url" class="block text-sm font-medium text-gray-200 mb-1">Video URL</label>
          <input id="url" name="url" type="url" placeholder="https://..." value="{{ submitted_url|default:'' }}"
                 class="w-full bg-slate-900/60 text-gray-100 placeholder-gray-400 border border-slate-700 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500" />
        </div>
        <div>
          <label for="quality" class=" block text-sm font-medium text-gray-200 mb-1">Quality</label>
          <select id="quality" name="quality" class="w-full bg-slate-900/60 text-gray-100 border border-slate-700 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500">
            <option value="1" {% if quality == '1' %}selected{% endif %}>4K</option>
            <option value="2" {% if quality == '2' %}selected{% endif %}>2K</option>
            <option value="3" {% if quality == '3' %}selected{% endif %}>1080p</option>
            <option value="4" {% if quality == '4' or not quality %}selected{% endif %}>720p</option>
            <option value="5" {% if quality == '5' %}selected{% endif %}>480p</option>
            <option value="6" {% if quality == '6' %}selected{% endif %}>360p</option>
            <option value="7" {% if quality == '7' %}selected{% endif %}>240p</option>
            <option value="8" {% if quality == '8' %}selected{% endif %}>144p</option>
            <option value="9" {% if quality == '9' %}selected{% endif %}>Audio Only</option>
          </select>
        </div>
      </div>
      <div class="mt-4">
        <button id="download-btn" type="submit" class="w-full cursor-pointer inline-flex items-center justify-center rounded-md bg-red-600 px-5 py-2.5 text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
          Download
        </button>
      </div>
    </form>
    <iframe name="download-frame" id="download-frame" class="hidden" style="display:none"></iframe>

    {% if submitted_url %}
      <div class="mt-6 text-sm text-gray-700">
        <span class="font-medium">Submitted:</span> {{ submitted_url }}
      </div>
    {% endif %}
  </div>
</section>
{% endblock %}

{% block footer %}
{{ block.super }}
<script>
  (function() {
    var form = document.getElementById('download-form');
    if (!form) return;
    var btn = document.getElementById('download-btn');
    var iframe = document.getElementById('download-frame');
    function resetButton() {
      if (!btn) return;
      btn.disabled = false;
      btn.textContent = 'Download';
      btn.classList.remove('bg-gray-600','cursor-not-allowed');
      if (!btn.classList.contains('bg-red-600')) btn.classList.add('bg-red-600');
      if (!btn.classList.contains('hover:bg-red-700')) btn.classList.add('hover:bg-red-700');
    }
    // Reset on page load or back/forward cache restore
    window.addEventListener('DOMContentLoaded', resetButton);
    window.addEventListener('pageshow', function(e){ if (e.persisted) resetButton(); else resetButton(); });
    // Reset when window regains focus (common after download dialog closes)
    window.addEventListener('focus', resetButton);
    document.addEventListener('visibilitychange', function(){ if (!document.hidden) resetButton(); });
    // Reset when iframe load event fires (form target)
    if (iframe) { iframe.addEventListener('load', resetButton); }
    form.addEventListener('submit', function() {
      if (!btn) return;
      btn.disabled = true;
      btn.textContent = 'Preparing...';
      btn.classList.remove('bg-red-600','hover:bg-red-700');
      btn.classList.add('bg-gray-600','cursor-not-allowed');
      // Fallback: ensure reset even if no navigation events fire
      setTimeout(resetButton, 5000);
    });
  })();
</script>
{% endblock %}


